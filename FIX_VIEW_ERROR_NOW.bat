@echo off
color 0A
title FIX: View Not Found Error
cls
echo.
echo ??????????????????????????????????????????????????????????????
echo ?                                                            ?
echo ?        ?? FIXING "VIEW NOT FOUND" ERROR ??                ?
echo ?                                                            ?
echo ??????????????????????????????????????????????????????????????
echo.
echo   What's happening:
echo   - Stopping all running instances...
echo   - Cleaning cached files...
echo   - Rebuilding fresh...
echo   - Starting everything properly...
echo.
echo   ??  This takes about 20 seconds...
echo.
echo ????????????????????????????????????????????????????????????
echo.

REM Step 1: Stop everything
echo [1/6] ?? Stopping dotnet and ngrok...
taskkill /F /IM dotnet.exe /T >nul 2>&1
taskkill /F /IM ngrok.exe /T >nul 2>&1
timeout /t 2 >nul
echo       ? Stopped

REM Step 2: Clean dotnet build
echo [2/6] ?? Cleaning build artifacts...
dotnet clean >nul 2>&1
echo       ? Cleaned

REM Step 3: Remove obj and cached views
echo [3/6] ???  Removing cached views...
if exist "obj" rd /s /q "obj" >nul 2>&1
if exist "bin\Debug\net8.0\Views" rd /s /q "bin\Debug\net8.0\Views" >nul 2>&1
echo       ? Cache cleared

REM Step 4: Fresh build
echo [4/6] ?? Building fresh (no cache)...
dotnet build --no-incremental >nul 2>&1
if errorlevel 1 (
    color 0C
    echo.
    echo       ? BUILD FAILED!
    echo.
    echo       Running detailed build to show errors...
    echo.
    dotnet build --no-incremental
    echo.
    pause
    exit /b 1
)
echo       ? Build successful

REM Step 5: Start app
echo [5/6] ?? Starting application...
start "TutorLiveMentor - Running on Port 5000" cmd /k "cd /d %~dp0 && echo Starting TutorLiveMentor... && timeout /t 2 >nul && dotnet run --urls http://0.0.0.0:5000"
timeout /t 8 >nul
echo       ? App started on port 5000

REM Step 6: Start ngrok
echo [6/6] ?? Starting ngrok tunnel...
start "Ngrok Tunnel - Port 5000" cmd /k "ngrok http 5000 --log=stdout"
timeout /t 5 >nul
echo       ? Ngrok started

REM Open dashboard
start "" "http://127.0.0.1:4040"

cls
color 0A
echo.
echo ??????????????????????????????????????????????????????????????
echo ?                                                            ?
echo ?              ? FIX COMPLETE! ??                          ?
echo ?                                                            ?
echo ??????????????????????????????????????????????????????????????
echo.
echo   ?? YOUR APP IS NOW RUNNING!
echo.
echo   ????????????????????????????????????????????????????????????
echo   ?                                                          ?
echo   ?  ?? Get Your Public URL:                                ?
echo   ?                                                          ?
echo   ?     http://127.0.0.1:4040                               ?
echo   ?     ? ? ? ? ? ? ? ? ? ? ?                              ?
echo   ?     Opens automatically in your browser!                ?
echo   ?                                                          ?
echo   ?  ?? Look for "Forwarding" and copy the URL             ?
echo   ?                                                          ?
echo   ?  Example:                                                ?
echo   ?     https://abc123.ngrok-free.app                       ?
echo   ?                                                          ?
echo   ????????????????????????????????????????????????????????????
echo.
echo   ? What was fixed:
echo      - Cached views were cleared
echo      - Fresh build completed
echo      - App restarted cleanly
echo      - Ngrok tunnel established
echo.
echo   ?? Test it:
echo      1. Local:  http://localhost:5000
echo      2. Public: Get from dashboard above
echo.
echo   ??  Keep these windows open:
echo      - This window
echo      - TutorLiveMentor window
echo      - Ngrok window
echo.
echo   ?? To restart later: Run this file again!
echo.
echo ????????????????????????????????????????????????????????????
echo.
pause
